{% extends 'base.html' %}
{% load static %}

{% block title %}Select a Room{% endblock %}

{% block content %}
<div class="container mt-5">
   <div class="filter-section">
       <form method="get" class="card p-3">
           <div class="row g-3">
               <div class="col-md-3">
                   <label for="check_in" class="form-label">Check In</label>
                   <input type="date" class="form-control" id="check_in" name="check_in" 
                          min="{{ today|date:'Y-m-d' }}" value="{{ request.GET.check_in }}">
               </div>
               <div class="col-md-3">
                   <label for="check_out" class="form-label">Check Out</label>
                   <input type="date" class="form-control" id="check_out" name="check_out"
                          min="{{ today|date:'Y-m-d' }}" value="{{ request.GET.check_out }}">
               </div>
               <div class="col-md-3">
                   <label for="room_type" class="form-label">Room Type</label>
                   <select class="form-select" id="room_type" name="room_type">
                       <option value="">All Types</option>
                       {% for type in room_types %}
                           <option value="{{ type.0 }}" {% if request.GET.room_type == type.0 %}selected{% endif %}>
                               {{ type.1 }}
                           </option>
                       {% endfor %}
                   </select>
               </div>
               <div class="col-md-3">
                   <label for="price_range" class="form-label">Max Price</label>
                   <input type="range" class="form-range room-price-range" 
                          id="price_range" 
                          name="max_price"
                          min="0" 
                          max="1000" 
                          step="50" 
                          value="{{ request.GET.max_price|default:1000 }}"
                          data-display-target="price_display">
                   <div class="text-end" id="price_display"></div>
               </div>
               <div class="col-12">
                   <div class="card amenities-filter">
                       <div class="card-body">
                           <label class="form-label">Amenities</label>
                           <div class="row">
                               {% for amenity in amenities %}
                                   <div class="col-md-4">
                                       <div class="form-check">
                                           <input class="form-check-input" type="checkbox" name="amenities" 
                                                  value="{{ amenity.id }}" id="amenity_{{ amenity.id }}"
                                                  {% if amenity.id|stringformat:"s" in request.GET.amenities %}checked{% endif %}>
                                           <label class="form-check-label" for="amenity_{{ amenity.id }}">
                                               {{ amenity.name }}
                                           </label>
                                       </div>
                                   </div>
                               {% endfor %}
                           </div>
                       </div>
                   </div>
               </div>
               <div class="col-12">
                   <button type="submit" class="btn btn-primary">Search Rooms</button>
                   <a href="{% url 'select_room' %}" class="btn btn-secondary">Clear Filters</a>
               </div>
           </div>
       </form>
   </div>

   {% if messages %}
       {% for message in messages %}
           <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
               {{ message }}
               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
           </div>
       {% endfor %}
   {% endif %}

   <h2 class="mb-4">Available Rooms {% if rooms %}<span class="text-muted">({{ rooms|length }} found)</span>{% endif %}</h2>
   
   <div class="row">
       {% for room in rooms %}
           <div class="col-md-4 mb-4">
               <div class="card room-card h-100">
                   <div class="position-absolute top-0 end-0 m-2">
                       <span class="badge bg-primary">{{ room.get_room_type_display }}</span>
                   </div>
                   
                   {% if room.images.first %}
                        <img src="{{ room.images.first.image.url }}" 
                             class="card-img-top room-image" 
                             alt="{{ room.name }}"
                             style="height: 200px; object-fit: cover;">
                    {% else %}
                        <img src="{% static 'images/placeholder.jpg' %}" 
                             class="card-img-top room-image" 
                             alt="No image available"
                             style="height: 200px; object-fit: cover;">
                    {% endif %}
                   
                   <div class="card-body d-flex flex-column">
                       <h5 class="card-title">{{ room.name }}</h5>
                       <p class="card-text">{{ room.description|truncatewords:20 }}</p>
                       
                       <div class="mb-3">
                           <small class="text-muted">
                               <i class="fas fa-user me-2"></i>Up to {{ room.max_occupancy }} guests
                           </small>
                           <br>
                           <small class="text-muted">
                               <i class="fas fa-ruler-combined me-2"></i>{{ room.size }} sq ft
                           </small>
                           {% if room.amenities.all %}
                               <div class="mt-2">
                                   {% for amenity in room.amenities.all|slice:":3" %}
                                       <span class="badge bg-light text-dark me-1">{{ amenity.name }}</span>
                                   {% endfor %}
                                   {% if room.amenities.all|length > 3 %}
                                       <span class="badge bg-light text-dark">+{{ room.amenities.all|length|add:"-3" }}</span>
                                   {% endif %}
                               </div>
                           {% endif %}
                       </div>
                       
                       <div class="mt-auto">
                           <p class="card-text h5 mb-3 text-primary">${{ room.price }} <small class="text-muted">per night</small></p>
                           
                           {% if user.is_authenticated %}
                               <a href="{% url 'book_room' room.id %}" class="btn btn-primary w-100">
                                   <i class="fas fa-calendar-check me-2"></i>Book Now
                               </a>
                           {% else %}
                               <div class="alert alert-info mb-0 text-center">
                                   Please <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">login</a> to book this room
                               </div>
                           {% endif %}
                       </div>
                   </div>
               </div>
           </div>
       {% empty %}
           <div class="col-12">
               <div class="alert alert-info">
                   <i class="fas fa-info-circle me-2"></i>No rooms available for the selected criteria. 
                   Try different dates or room types.
               </div>
           </div>
       {% endfor %}
   </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.room-image {
    height: 200px;
    object-fit: cover;
}

.room-card {
    transition: transform 0.2s ease-in-out;
}

.room-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
